<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="STATISTIC_REPORT">
  
  <resultMap class="com.tdil.tuafesta.model.valueobjects.StatisticValueObject" id="StatisticValueObject">
    <result column="data" jdbcType="VARCHAR" property="data" />
    <result column="objecttime" jdbcType="VARCHAR" property="objecttime" />
    <result column="quantity" jdbcType="INTEGER" property="quantity" />
  </resultMap>
  
  
  <select id="prodCategoryStats" parameterClass="java.util.Map" resultMap="StatisticValueObject">
    select 
    	<isNotNull property="objectna">
        	'n/a' as data,
    	</isNotNull>
    	<isNull property="objectna">
	    	cat.name as data,
    	</isNull>

    	<isNotNull property="datena">
        	'n/a' as objecttime,
    	</isNotNull>
    	<isNull property="datena">
	    	DATE_FORMAT(st.objectTime,#dateformated:VARCHAR#) as objecttime,
    	</isNull>
    	<isNotNull property="groupby">
        	sum(1) as quantity
    	</isNotNull>
    	<isNull property="groupby">
        	1 as quantity
    	</isNull>
    from STATISTIC st, PROF_PROD_CATEGORY cat
    where st.statType = 1
	and st.objectId = cat.id
	<isNotNull property="sFrom">
        	and objecttime >= #sFrom:TIMESTAMP#
    </isNotNull>
    <isNotNull property="sTo">
        	and objecttime &lt;= #sTo:TIMESTAMP#
    </isNotNull>
	<dynamic prepend="group by">
		<isNotNull prepend="," property="groupbyobject">
        	cat.id, cat.name
    	</isNotNull>
		<isNotNull prepend="," property="groupbydate">
        	DATE_FORMAT(st.objectTime,#dateformated:VARCHAR#)
    	</isNotNull>
    </dynamic>
  </select>
  
  <select id="servCategoryStats" parameterClass="java.util.Map" resultMap="StatisticValueObject">
    select 
    	<isNotNull property="objectna">
        	'n/a' as data,
    	</isNotNull>
    	<isNull property="objectna">
	    	cat.name as data,
    	</isNull>

    	<isNotNull property="datena">
        	'n/a' as objecttime,
    	</isNotNull>
    	<isNull property="datena">
	    	DATE_FORMAT(st.objectTime,#dateformated:VARCHAR#) as objecttime,
    	</isNull>
    	<isNotNull property="groupby">
        	sum(1) as quantity
    	</isNotNull>
    	<isNull property="groupby">
        	1 as quantity
    	</isNull>
    from STATISTIC st, PROF_SERV_CATEGORY cat
    where st.statType = 1
	and st.objectId = cat.id
	<isNotNull property="sFrom">
        	and objecttime >= #sFrom:TIMESTAMP#
    </isNotNull>
    <isNotNull property="sTo">
        	and objecttime &lt;= #sTo:TIMESTAMP#
    </isNotNull>
	<dynamic prepend="group by">
		<isNotNull prepend="," property="groupbyobject">
        	cat.id, cat.name
    	</isNotNull>
		<isNotNull prepend="," property="groupbydate">
        	DATE_FORMAT(st.objectTime,#dateformated:VARCHAR#)
    	</isNotNull>
    </dynamic>
  </select>
  
  
    <select id="geoLevelStats" parameterClass="java.util.Map" resultMap="StatisticValueObject">
    select 
    	<isNotNull property="objectna">
        	'n/a' as data,
    	</isNotNull>
    	<isNull property="objectna">
	    	geo4.nombre as data,
    	</isNull>

    	<isNotNull property="datena">
        	'n/a' as objecttime,
    	</isNotNull>
    	<isNull property="datena">
	    	DATE_FORMAT(st.objectTime,#dateformated:VARCHAR#) as objecttime,
    	</isNull>
    	<isNotNull property="groupby">
        	sum(1) as quantity
    	</isNotNull>
    	<isNull property="groupby">
        	1 as quantity
    	</isNull>
    from STATISTIC st, GEO4 geo4
    where st.statType = 0
	and st.objectId = geo4.id
	<isNotNull property="sFrom">
        	and objecttime >= #sFrom:TIMESTAMP#
    </isNotNull>
    <isNotNull property="sTo">
        	and objecttime &lt;= #sTo:TIMESTAMP#
    </isNotNull>
	<dynamic prepend="group by">
		<isNotNull prepend="," property="groupbyobject">
        	geo4.id, geo4.name
    	</isNotNull>
		<isNotNull prepend="," property="groupbydate">
        	DATE_FORMAT(st.objectTime,#dateformated:VARCHAR#)
    	</isNotNull>
    </dynamic>;
  </select>
</sqlMap>